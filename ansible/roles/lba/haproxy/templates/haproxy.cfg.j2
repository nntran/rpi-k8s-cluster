global
    log /dev/log  local0
    log /dev/log  local1 notice
    maxconn {{ haproxy_maxconn }}
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user {{ haproxy_user }}
    group {{ haproxy_group }}
    daemon
{% for global_var in haproxy_global_vars %}
    {{ global_var }}
{% endfor %}

defaults
    log global
    mode  http
    option  httplog
    option  dontlognull
{% if haproxy_version is version('1.4', '<=') %}
    contimeout {{ haproxy_connect_timeout }}
    clitimeout {{ haproxy_client_timeout }}
    srvtimeout {{ haproxy_server_timeout }}
{% else %}
    timeout connect {{ haproxy_connect_timeout }}
    timeout client {{ haproxy_client_timeout }}
    timeout server {{ haproxy_server_timeout }}
{% endif %}
{% if ansible_os_family == 'Debian' %}
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http
{% endif %}


#########################################################################
################################ FRONTEND ###############################

frontend kubernetes-api-in
    bind *:6443
    mode tcp
    option tcplog
    default_backend kubernetes-api

frontend http-in
    bind *:80
    mode http #Activation du mode HTTP
    option httplog #Activation des logs
    option forwardfor

    # Proxy Traefik
    acl is_traefik_dashboard hdr(host) -i traefik.dev.lan
    use_backend traefik-dashboard if is_traefik_dashboard
    
    # Default redirect
    default_backend traefik-http

frontend https-in
    bind *:443
    mode tcp
    #Activation des logs
    option tcplog

    # Proxy Traefik
    acl is_traefik_dashboard hdr(host) -i traefik.dev.lan
    use_backend traefik-dashboard if is_traefik_dashboard

    #Si aucun acl est valide, utiliser le backend "traefik-https"
    default_backend traefik-https


#########################################################################
################################ BACKEND ################################

backend kubernetes-api
    mode tcp
    balance {{ haproxy_backend_balance_method }}
    # balance leastconn
    option tcp-check

    # Cluster K8S
{% if haproxy_backend_httpchk != '' %}
    option httpchk {{ haproxy_backend_httpchk }}
{% endif %}
    cookie SERVERID insert indirect
{% for backend in haproxy_backend_servers %}
    server {{ backend.name }} {{ backend.address }}:6443 cookie {{ backend.name }} check fall 3 rise 2
{% endfor %}

backend traefik-http
    mode http
    balance {{ haproxy_backend_balance_method }}
    # balance leastconn
    option forwardfor except 127.0.0.1
    # http-request set-header X-Forwarded-Port %[dst_port]
    # http-request add-header X-Forwarded-Proto https if { ssl_fc }
    # option httpchk HEAD / HTTP/1.1rnHost:localhost

    # Cluster K8S
{% if haproxy_backend_httpchk != '' %}
    option httpchk {{ haproxy_backend_httpchk }}
{% endif %}
    cookie SERVERID insert indirect
{% for backend in haproxy_backend_servers %}
    server {{ backend.name }} {{ backend.address }}:31080 cookie {{ backend.name }} check fall 3 rise 2
{% endfor %}

backend traefik-https
    mode http
    balance {{ haproxy_backend_balance_method }}
    # option tcp-check

    # Cluster K8S
{% if haproxy_backend_httpchk != '' %}
    option httpchk {{ haproxy_backend_httpchk }}
{% endif %}
    cookie SERVERID insert indirect
{% for backend in haproxy_backend_servers %}
    server {{ backend.name }} {{ backend.address }}:31443 cookie {{ backend.name }} check fall 3 rise 2
{% endfor %}

backend traefik-dashboard
    mode http
    balance {{ haproxy_backend_balance_method }}
    #balance leastconn

    # Cluster K8S
{% if haproxy_backend_httpchk != '' %}
    option httpchk {{ haproxy_backend_httpchk }}
{% endif %}
    cookie SERVERID insert indirect
{% for backend in haproxy_backend_servers %}
    server {{ backend.name }} {{ backend.address }}:31880 cookie {{ backend.name }} check fall 3 rise 2
{% endfor %}

#########################################################################
################################# STATS #################################

listen stats
    bind *:32700
    stats enable
    stats uri /stats
    stats hide-version
    stats refresh 30s
    stats show-node
    stats auth username:password
    stats auth admin:admin